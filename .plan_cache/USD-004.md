# Plan: AAM Deployment and Hierarchical Demo

**Task ID:** USD-004
**Created:** 2026-02-07T11:12:00Z
**Approved by:** Doni

## Objective

Deploy the Agent Allowance Manager (AAM) contract to Arc Testnet and set up a hierarchical demo:
- Doni (Human) → Borg + Gem (Agents) → Subagents for each

## Context

- **Contract location:** `~/agent-allowance/src/AAM.sol`
- **Deploy script:** `~/agent-allowance/script/Deploy.s.sol`
- **Tests:** 22 passing, CI green
- **GitHub:** https://github.com/chosta/agent-allowance
- **Target chain:** Arc Testnet
  - Chain ID: `5042002`
  - RPC: `https://rpc.testnet.arc.network`
  - Explorer: `https://testnet.arcscan.app`
  - Native token: USDC (gas paid in USDC)
- **Faucet:** https://faucet.circle.com (select Arc Testnet)
- **USDC on Arc:** `0x3600000000000000000000000000000000000000` (native USDC interface)

## Hierarchy Structure

```
Doni (Human) - Pool: 18 USDC
├── Borg (Agent) - Allowance: 9 USDC/week
│   ├── SubagentA - Allowance: 2 USDC/week
│   └── SubagentB - Allowance: 2 USDC/week
└── Gem (Agent) - Allowance: 9 USDC/week
    ├── SubagentX - Allowance: 2 USDC/week
    └── SubagentY - Allowance: 2 USDC/week
```

## Execution Steps

### Phase 1: Wallet Setup

1. Generate 6 wallets using `cast wallet new`:
   - Deployer (temporary, for deployment only)
   - Borg (main agent)
   - Gem (main agent)
   - SubagentA, SubagentB (Borg's subagents)
   - SubagentX, SubagentY (Gem's subagents... or just use 4 total subagents)

2. Save all private keys to `~/agent-allowance/.env.testnet` (gitignored)

3. Output the DEPLOYER address to user for funding

### Phase 2: User Funding

4. **STOP and ask user** to fund deployer with ~24 USDC from faucet.circle.com
   - They may need multiple faucet requests (10 USDC each)
   - Alternative: console.circle.com for 20 USDC/request

5. Wait for confirmation that funds are received

### Phase 3: Deployment

6. Set environment variables:
   ```bash
   source ~/agent-allowance/.env.testnet
   export USDC_ADDRESS=0x3600000000000000000000000000000000000000
   ```

7. Deploy contract:
   ```bash
   cd ~/agent-allowance
   forge script script/Deploy.s.sol --rpc-url https://rpc.testnet.arc.network --broadcast
   ```

8. Record deployed contract address

9. Verify on Arcscan if supported

### Phase 4: Hierarchy Setup (User Actions)

10. User needs to:
    - Send 18 USDC to their own wallet (the "manager" wallet)
    - Approve AAM contract to spend their USDC
    - Call `deposit(18 USDC)`
    - Call `createAllowance(Borg, CAP, 9 USDC, 1 week)`
    - Call `createAllowance(Gem, CAP, 9 USDC, 1 week)`

    Provide cast commands or guide through explorer.

### Phase 5: Agent Hierarchy Setup (Bot Actions)

11. As Borg:
    - `spend(Doni, 50, BorgWallet)` — withdraw 4 USDC
    - `deposit(50)` — deposit into Borg's pool
    - `createAllowance(SubagentA, CAP, 25, 1 week)`
    - `createAllowance(SubagentB, CAP, 25, 1 week)`

12. As Gem (or spawn Gem subagent to do this):
    - Same pattern: spend → deposit → create allowances

### Phase 6: Demo Transactions

13. Each subagent spends a small amount (1 USDC) to prove the hierarchy works

14. Log all transactions

### Phase 7: Verification & Scripts

15. Write `hierarchy_status.sh`:
    ```bash
    #!/bin/bash
    # Shows full tree of balances and allowances
    CONTRACT=<deployed_address>
    RPC=https://rpc.testnet.arc.network
    
    echo "=== Doni (Root) ==="
    cast call $CONTRACT "balanceOf(address)" $DONI_ADDRESS --rpc-url $RPC
    
    echo "=== Borg Allowance ==="
    cast call $CONTRACT "getAvailable(address,address)" $DONI_ADDRESS $BORG_ADDRESS --rpc-url $RPC
    # ... etc
    ```

16. Optional: Set up cron job for recurring simulation

## Success Criteria

- [ ] Contract deployed to Arc Testnet
- [ ] Contract address recorded
- [ ] Doni's pool funded with 18 USDC
- [ ] Borg and Gem have active allowances from Doni
- [ ] Borg has pool with subagent allowances
- [ ] Gem has pool with subagent allowances
- [ ] At least 4 successful spend transactions from subagents
- [ ] `hierarchy_status.sh` script works

## Notes

- No ownership transfer or renounce functions needed
- Keep contract as-is, no modifications
- Arc uses USDC as gas token (no ETH needed)
- If Arc has issues, fallback to Base Sepolia

## Environment File Template

```bash
# ~/agent-allowance/.env.testnet
DEPLOYER_PRIVATE_KEY=0x...
BORG_PRIVATE_KEY=0x...
GEM_PRIVATE_KEY=0x...
SUBAGENT_A_PRIVATE_KEY=0x...
SUBAGENT_B_PRIVATE_KEY=0x...

DEPLOYER_ADDRESS=0x...
BORG_ADDRESS=0x...
GEM_ADDRESS=0x...
SUBAGENT_A_ADDRESS=0x...
SUBAGENT_B_ADDRESS=0x...

USDC_ADDRESS=0x3600000000000000000000000000000000000000
RPC_URL=https://rpc.testnet.arc.network
```
